# ADC相关知识及对应库函数

根据兆易创新提供的库函数中文使用文档和库函数源码，学习相关 ADC 采样的集中模式和机制。

## 1. 简介
MCU 片上集成了 12 位逐次逼近式模数转换器模块（ADC），可以采样来自于 16 个外部通道
和 2 个内部通道上的模拟信号。这 18 个 ADC 采样通道都支持多种运行模式，采样转换后，转
换结果可以按照最低有效位对齐或最高有效位对齐的方式保存在相应的数据寄存器中。

- 高性能：
    - ADC分辨率：12位分辨率；
    - 前置校准功能；
    - 可编程采样时间；
    - 数据存储模式：最高有效位对齐和最低有效位对齐；
    - DMA请求。
- 模拟输入通道：
    - 16个外部模拟输入通道；
    - 1个内部温度传感通道(VSENSE)；
    - 1个内部参考电压输入通道(VREFINT)。
- 运行模式：
    - 软件；
    - 硬件触发。
- 转换模式：
    - 转换单个通道，或者扫描一序列的通道；
    - 单次运行模式，每次触发转换一次选择的输入通道；
    - 连续运行模式，连续转换所选择的输入通道；
    - 间断运行模式；
    - 同步模式（适用于具有两个或多个ADC的设备）。
- 转换结果阈值监测器功能：模拟看门狗。
- 中断的产生：
    - 常规序列转换结束；
    - 模拟看门狗事件。
- 通道输入范围：VREFN ≤VIN ≤VREFP

## 2. 运行模式
### 2.1. 单次运行模式：
**即每次采集需要用户自行启动，启动一次采集一次。**

常规序列单次运行模式的软件流程：
1. 确保ADC_CTL0寄存器的DISRC和SM位以及ADC_CTL1寄存器的CTN位为0；
2. 用模拟通道编号来配置RSQ0；
3. 配置ADC_SAMPTx寄存器；
4. 如果有需要，可以配置ADC_CTL1寄存器的ETERC和ETSRC位；
5. 设置SWRCST位，或者为常规序列产生一个外部触发信号；
6. 等到EOC置1；
7. 延迟一个CK_ADC后，从ADC_RDATA寄存器中读ADC转换结果；
8. 写0清除EOC标志位。
注意：当 EOC 置 1 后，需延迟一个 CK_ADC 再读取 ADC 转换结果。

### 2.2. 连续运行模式
**采集开始后，自动周期性采集数据并置位，采集周期由 CK_ADC 设置，每个周期开始时采集一次。**

常规序列连续运行模式的软件流程：
1. 设置ADC_CTL1寄存器的CTN位为1；
2. 根据模拟通道编号配置RSQ0；
3. 配置ADC_SAMPTx寄存器；
4. 如果有需要，配置ADC_CTL1寄存器的ETERC和ETSRC位；
5. 设置SWRCST位，或者给常规序列产生一个外部触发信号；
6. 等待EOC标志位置1；
7. 延迟一个CK_ADC后，从ADC_RDATA寄存器中读ADC转换结果；
8. 写0清除EOC标志位；
9. 只要还需要进行连续转换，重复步骤6~8。

注意：当 EOC 置 1 后，需延迟一个 CK_ADC 再读取 ADC 转换结果。
由于要循环查询 EOC 标志位，DMA 可以被用来传输转换数据，软件流程如下：
1. 设置ADC_CTL1寄存器的CTN位为1；
2. 根据模拟通道编号配置RSQ0；
3. 配置ADC_SAMPTx寄存器；
4. 如果有需要，配置ADC_CTL1寄存器的ETERC和ETSRC位；
5. 准备DMA模块，用于传输来自ADC_RDATA的数据；
6. 设置SWRCST位，或者给常规序列产生一个外部触发。

### 2.3. 扫描运行模式
扫描运行模式可以通过将 ADC_CTL0 寄存器的 SM 位置 1 来使能。在此模式下，ADC 扫描转
换所有被 ADC_RSQ0~ADC_RSQ2 寄存器选中的所有通道。一旦 ADCON 位被置 1，当相应
软件触发或者外部触发产生，ADC 就会一个接一个的采样和转换常规序列通道。转换数据存
储在 ADC_RDATA 寄存器中。常规序列转换结束后，EOC 位将被置 1。如果 EOCIE 位被置
1，将产生中断。当常规序列工作在扫描模式下时，ADC_CTL1 寄存器的 DMA 位必须设置为
1。
如果 ADC_CTL1 寄存器的 CTN 位也被置 1，则在常规序列转换完之后，这个转换自动重新开
始。

常规序列扫描运行模式的软件流程：
1. 设置 ADC_CTL0 寄存器的 SM 位和 ADC_CTL1 寄存器的 DMA 位为 1；
2. 配置 ADC_RSQx 和 ADC_SAMPTx 寄存器；
3. 如果有需要，配置 ADC_CTL1 寄存器中的 ETERC 和 ETSRC 位；
4. 准备 DMA 模块，用于传输来自 ADC_RDATA 的数据；
5. 设置 SWRCST 位，或者给常规序列产生一个外部触发；
6. 等待 EOC 标志位置 1；
7. 写 0 清除 EOC 标志位。

## 3. 同步模式
在有多个ADC模块的产品中，可以使用ADC同步模式。

在ADC同步模式下，根据 ADC_CTL0 寄存器中 SYNCM[3:0] 位所选的模式，
转换的启动可以是 ADC0 和 ADC1 的交替触发或同步触发。

在同步模式下，当配置由外部事件触发的转换时， ADC0 必须通过软件来配置触发，从而避
免错误的触发引起不必要的转换。此外，对于 ADC0 和 ADC1 的外部触发必须被使能。

在ADC同步模式下，即使DMA不用，也要将DMA置位，ADC1的转换数据可以通过ADC0数据寄存器读取。

### 3.1. 独立模式
在这种模式下，每个 ADC 都独立工作，互不干扰。

**即可以设置使用不同的采样周期。**

### 3.2. 常规并行模式
**即两个通道同时并行采集数据，采集完成后 EOC 置位。**

此模式可并行转换常规序列，外部触发来源于 ADC0 常规序列触发（由 ADC_CTL1 寄存器的
ETSRC[2:0]决定），ADC1 常规序列配置为软件触发模式。

在 ADC0 或 ADC1 的转换事件结束时，即 ADC0 或 ADC1 的常规序列转换完毕，会产生一个
EOC 中断（如果某个 ADC 中断使能）。

32 位 ADC_RDATA 寄存器（ [15: 0]位域用于保存 ADC0 常规通道采样数据，[31: 16]位域用
于保存 ADC1 常规通道采样数据），32 位的 DMA 被用来将 ADC_RDATA 中的数据传送到
SRAM。

- 注意：
    1. 若两个 ADC 模块使用了相同的采样通道，应保证不在同一时间使用该通道。
    2. 两个 ADC 在同一时刻采样的两个通道，应该配置相同的采样时间。

### 3.3. 常规快速交叉模式
**即 ADC0 在 ADC1 采集开始 7 个 ADC 时钟周期后开始采集，每个通道采集完成后自己的 EOC 标志位，即 EOC 标志位交叉置位。**

快速交叉模式适用于两个 ADC 的常规序列采样同一个通道，外部触发来源于 ADC0 常规序列（由 ADC_CTL1 寄存器的 ETSRC[2:0]决定）。

当触发产生时，ADC1 立刻启动，而 ADC0在 7 个 ADC 时钟周期后启动。

如果 ADC0 和 ADC1 的 CTN 位被置位，所选的常规序列在两个 ADC 中被不停的转换。

32 位 ADC_RDATA 寄存器（[15: 0]位域用于保存 ADC0 常规通道采样数据，[31: 16]位域用于
保存 ADC1 常规通道采样数据）。

在 ADC0 产生 EOC 中断后(可通过置位 EOCIE 位)，可通过 32 位 DMA 将 ADC_RDATA 中数据传送到 SRAM。

注意：两个 ADC 模块常规通道的采样时间都应小于 7 个 ADC 时钟周期。

### 3.4. 常规慢速交叉模式
**即 ADC0 在 ADC1 采集开始 14 个 ADC 时钟周期后开始采集。 ADC1 后续采集需要从 ADC0 开始采集后的第 15 个 ADC 时钟周期重新开始采集。**

此模式应用于两个 ADC 的常规序列（通常一个常规通道），外部触发来源于 ADC0 常规序列（由 ADC_CTL1 寄存器的 ETSRC[2:0]决定）。

当触发产生时，ADC1 立刻启动，而 ADC0 在14 个 ADC 时钟周期后启动，在 ADC0 启动后的 14 个时钟周期，ADC1 再次启动。

在这种模式下，不能使用连续转换模式，因为在这种模式下所选的常规通道在两个 ADC 中被不停的转换。

32 位 ADC_RDATA 寄存器（[15: 0]位域用于保存 ADC0 常规通道采样数据，[31: 16]位域用于保存 ADC1 常规通道采样数据）。

在 ADC0 产生 EOC 中断后(可通过置位 EOCIE 位)，可通过 32 位 DMA 将 ADC_RDATA 中数据传送到 SRAM。

注意：可允许的最大采样时间必须小于 14 个 CK_ADC 采样时钟，从而避免 ADC0 和 ADC1 在转换相同通道时出现采样时钟重叠。