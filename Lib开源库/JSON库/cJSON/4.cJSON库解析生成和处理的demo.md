# cJSON 库解析生成和处理的 demo
主要展示一个对 json 格式字符串进行解析、生成和处理的基本 demo，包括 json 字符串的解析、生成和处理。

## 1. 代码
示例代码文件结构如下：
```filetree
.
├── set_simple_JSON.c
├── Makefile
├── cJSON/
   ├── cJSON_Utils.c
   └── cJSON_Utils.h
   ├── cJSON.c
   └── cJSON.h
```

## 2. 代码展示
## 2.1. makefile 源文件展示
```makefile
CJSON_OBJ = cJSON.o
UTILS_OBJ = cJSON_Utils.o
CJSON_TEST = cJSON_test

CJSON_TEST_SRC = ./cJSON/cJSON.c set_simple_JSON.c

LDLIBS = -lm

CC = gcc -std=c99

.PHONY: all tests clean

all: tests

tests: $(CJSON_TEST)

test: tests
	./$(CJSON_TEST)

.c.o:
	$(CC) -c $(R_CFLAGS) $<

#tests
#cJSON
$(CJSON_TEST): $(CJSON_TEST_SRC) ./cJSON/cJSON.h
	$(CC) $(R_CFLAGS) $(CJSON_TEST_SRC)  -o $@ $(LDLIBS) -I.

#objects
#cJSON
$(CJSON_OBJ): ./cJSON/cJSON.c ./cJSON/cJSON.h
#cJSON_Utils
$(UTILS_OBJ): ./cJSON/cJSON_Utils.c ./cJSON/cJSON_Utils.h ./cJSON/cJSON.h

clean:
	$(RM) $(CJSON_OBJ) $(UTILS_OBJ) #delete object files
	$(RM) $(CJSON_TEST)  #delete test

```


## 2.2. C 语言文件展示
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "cJSON/cJSON.h"

/* 自定义分配函数 */
void* my_malloc(size_t size) {
    // printf("Allocating %zu bytes\n", size);
    return malloc(size);
}

/* 自定义释放函数 */
void my_free(void *ptr) {
    // printf("Freeing memory at %p\n", ptr);
    free(ptr);
}

/* json 解析函数展示 */
void parse_exist_json(void)
{
    printf("|----------------------------------------------<<<<<<<< start parse_exist_json() function \n");

    char exist_json[] = "{\"name\":\"Json.CN\",\"url\":\"http://www.json.cn\",\"page\":88,\"isNonProfit\":true,\"address\":{\"street\":\"科技园路.\",\"city\":\"江苏苏州\",\"country\":\"中国\"},\"links\":[{\"name\":\"Google\",\"url\":\"http://www.google.com\"},{\"name\":\"Baidu\",\"url\":\"http://www.baidu.com\"}]}";
    const char **json_end = NULL;
    // cJSON* root = cJSON_Parse(exist_json);
    // cJSON* root = cJSON_ParseWithLength(exist_json, sizeof(exist_json));
    cJSON* root = cJSON_ParseWithLengthOpts(exist_json, sizeof(exist_json), json_end, 1);
    if (root) {
        /* 解析 json 内容，如果不需要区分大小写，需要使用 cJSON_GetObjectItem() 函数作为替代  */
        cJSON *item = cJSON_GetObjectItemCaseSensitive(root, "name");
        if (item) {
            printf("name: %s\n", cJSON_GetStringValue(item));
        } else {
            printf("Error: No this Item\n");
        }

        /* 解析检查类型 */
        item = cJSON_GetObjectItemCaseSensitive(root, "isNonProfit");
        if (item) {
            printf("isNonProfit: %d\n", cJSON_IsTrue(item));
        } else {
            printf("Error: No this Item\n");
        }

    } else {
        printf("Error: %s\n", cJSON_GetErrorPtr());
    }

}

/* json 生成函数展示 */
cJSON* root = NULL;
cJSON* cjson_raw = NULL;
cJSON* cjson_array = NULL;
cJSON* cjson_object = NULL;
void create_new_json(void)
{
    printf("|----------------------------------------------<<<<<<<< start create_new_json() function \n");
    /* 创建一个JSON数据对象(链表头结点) */
    root = cJSON_CreateObject();

    cJSON_AddStringToObject(root, "name", "mculover666");
    cJSON_AddNumberToObject(root, "weight", 55.5);
    cJSON_AddFalseToObject(root, "student");

    /* 使用 raw 节点类型插入 */
    cjson_raw = cJSON_CreateRaw("{\"temp\":25.5, \"humi\":25.5}");
    cJSON_AddItemToObject(root, "sensor_data", cjson_raw);

    /* 使用 Array 节点类型插入 */
    cjson_array = cJSON_CreateArray();
    cJSON_AddItemToArray(cjson_array, cJSON_CreateString( "C" ));
    cJSON_AddItemToArray(cjson_array, cJSON_CreateString( "Java" ));
    cJSON *item = cJSON_CreateString("C++");
    cJSON_AddItemToArray(cjson_array, item);    /* 添加 item 到 array */
    cJSON_AddItemToObject(root, "skill", cjson_array);

    /* 使用 object 节点类型插入 */
    cjson_object = cJSON_CreateObject();
    cJSON_AddStringToObject(cjson_object, "country", "China");
    cJSON_AddNumberToObject(cjson_object, "zip-code", 111111);
    cJSON_AddItemToObject(root, "address", cjson_object);    

    /* 打印JSON对象(整条链表)的所有数据 */
    printf("%s\n", cJSON_Print(root));
}

/* json 操作函数示例 */
void modify_json(void)
{
    cJSON *array = NULL;
    cJSON *element = NULL;
    cJSON *item = NULL;

    printf("|----------------------------------------------<<<<<<<< start modify_json() function \n");

    /* 找到 root 中需要修改的节点 node */
    array = cJSON_GetObjectItemCaseSensitive(root, "skill");
    if (array) {
        printf("skill: %s\n", cJSON_Print(array));
    } else {
        printf("Error: No this Item：：%s\n", cJSON_GetErrorPtr());
    }

    /* 判断是否为数组并打印数组数据 */
    if(cJSON_IsArray(array)) {
        element = cJSON_GetArrayItem(array, 1);
        printf("array element 1 in skill array: %s\n", cJSON_Print(element));
    }

    /* 往已有 array 中新增数据 */
    element = cJSON_CreateString("Python");
    if(cJSON_AddItemToArray(array, element)) {
        printf("%s\n", cJSON_Print(root));
    }

    element = cJSON_DetachItemFromArray(array, 2);
    printf("--> Detached item from array value: %s\n", cJSON_Print(element));

    /* 往数组中插入元素，序号后的数据往后排列 */
    element = cJSON_CreateString("GO");
    if(cJSON_InsertItemInArray(array, 1, element)) {
        printf("--> Insert item value: %s\n", cJSON_Print(element));
        printf("%s\n", cJSON_Print(root));
    }

    /* 更新 array 中序号位的的元素 */
    element = cJSON_CreateString("Rust");
    if(cJSON_ReplaceItemInArray(array, 2, element)) {
        printf("--> Update item value: %s\n", cJSON_Print(element));
        printf("%s\n", cJSON_Print(root));
    }

    /* 从 root 分离一个 array 类型节点 */
    item = cJSON_DetachItemViaPointer(root, array);
    // item = cJSON_DetachItemFromObjectCaseSensitive(root, "skill");
    if (item) {
        printf("--> Detached item value: %s\n", cJSON_Print(item));
    } else {
        printf("--> Detached item ERROR: %s\n", cJSON_GetErrorPtr());
    }

    /* 打印JSON对象(整条链表)的所有数据 */
    printf("%s\n", cJSON_Print(root));

    char str[256] = {};
    /* 使用预分配内存导出json字符串，format为1表示有换行符、分隔符、空格等更直观的格式，format为0表示无 */
    cJSON_PrintPreallocated(root, str, sizeof(str), 1);
    /* 将有格式字符串转化为无格式字符串 */
    cJSON_Minify(str);
    printf("%s\n", str);
}

int main(int argc, char *argv[])
{
    printf("cJSON version : %s\n", cJSON_Version());

    /* 初始化自定义钩子 */
    cJSON_Hooks hooks = { my_malloc, my_free };
    cJSON_InitHooks(&hooks);

    parse_exist_json();

    create_new_json();

    modify_json();

    /* 删除 JSON，回收资源 */
    cJSON_Delete(root);

    return 0;
}
```