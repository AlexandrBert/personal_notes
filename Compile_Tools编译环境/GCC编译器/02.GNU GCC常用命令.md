# GNU GCC 常用命令

GNU GCC 完整命令的使用可以在 GNU GCC 官网的 “文档” -> [“3 GCC Command Options”](https://gcc.gnu.org/onlinedocs/gcc-15.1.0/gcc/#toc-GCC-Command-Options) 章节中介绍。

## 1. 常见的 GCC 编译命令选项
- **3.2 Options Controlling the Kind of Output**
    - *Overall Options*
        - `-c` ：编译或汇编源文件，但不要链接。
        - `-S` ：在编译阶段之后停止，不要汇编。
        - `-E` ：在预处理阶段之后停止；不运行编译。
        - `-o file` ：将主要输出放在文件中。这适用于生成的任何类型的输出，无论是可执行文件、目标文件、汇编文件还是预处理的C代码。如果未指定-o，则默认情况下将可执行文件放在.out中。
        - `-x language` ：显式指定以下输入文件的语言（而不是让编译器根据文件名后缀选择默认语言）。此选项适用于所有后续输入文件，直到下一个-x选项。语言的可能值为：
            - c  c-header  cpp-output c++  c++-header  c++-system-header c++-user-header c++-cpp-output objective-c  objective-c-header  bjective-c-cpp-output objective-c++ objective-c++-header objective-c++-cpp-output assembler  assembler-with-cpp ada cobol d f77  77-cpp-input f95  f95-cpp-input go
        - `-specs=file` ：指定一个或多个文件，这些文件包含对编译器的附加命令。这些文件通常具有.specs扩展名，但也可以是任何其他扩展名。这些文件通常包含对编译器的附加命令，如定义宏、指定编译器选项等。

- **3.4 Options Controlling C Dialect**
    - *C Language Options*
        - `-std=[standard]` ：确定语言标准。编译器可以接受几个基本标准，如'c90'或'c++98'，以及这些标准的GNU方言，如'gnu 90'或'gnu++98'。当指定了一个基本标准时，编译器接受所有遵循该标准的程序，以及那些使用与之不矛盾的GNU扩展的程序。-Wpedantic使用该特定标准来识别哪些功能是给定该标准版本的GNU扩展。例如，`-std=gnu90 -Wpedantic`警告C++样式的'//'注释，而 `-std=gnu99 -Wpedantic` 不警告。

- **3.9 Options to Request or Suppress Warnings**
    - *Warning Options*
        - `-Wall` ：启用大多数警告。
        - `-Wextra` ：启用一些额外的警告。
        - `-Werror` ：将警告视为错误。

- **3.11 Options for Debugging Your Program**
    - *Debugging Options*
        - `-g` ：生成调试信息，比如编译 STM32 时需要加入 -g 选项，这样在调试时才能看到调试信息。
        - `-gdwarf-2` ：指定调试信息的格式为 DWARF 2，这是目前最常用的调试信息格式。

- **3.12 Options That Control Optimization**
    - *Optimization Options*
        - `-O` ：优化等级，默认为 -O0，可以指定 -O0、-O1、-O2、-O3、-Os、-Ofast、-Og，指定的数字类等级越高优化越多，大数字包含小数字的优化类型。其中 `-Og` 在嵌入式用得较多，可以优化调试信息；-Os 启用了 -O2 的除了增加代码大小的所有优化；-Ofast 启用所有 -O3 优化。它还支持并非对所有符合标准的程序都有效的优化。
        - `-fdata-sections` ：告诉链接器将每个数据段放入单独的输出段中，每个段都命名为.data.name，其中name是段名的原始名称。这允许与链接器选项--gc-sections一起使用，以删除未使用的代码和数据。
        - `-ffunction-sections` ：告诉链接器将每个函数放入单独的输出段中，每个段都命名为.text.name，其中name是函数名的原始名称。这允许与链接器选项--gc-sections一起使用，以删除未使用的代码和数据。

- **3.14 Options Controlling the Preprocessor**
    - *Preprocessor Options*
        - `-C` ：
        - `-Dmacro[=defn]` : 用于编译时加入宏定义，比如 STM32 编译时会加入 -DUSE_HAL_DRIVER -DSTM32F103xB 用于指定使用的驱动库和芯片型号。
        - `-U name` ：取消宏定义，不论是内建还是通过 -D 定义。
        - `-MMD` ：类似于-MD，只是只提到用户头文件，而不是系统头文件。
        - `-MP` ：告诉预处理器为每个依赖项添加一个假目标，而不是主文件，从而使每个依赖项都不依赖于任何东西。如果您删除头文件而没有更新 Makefile 来匹配，这些虚拟规则可以解决 make gives 错误。
        - `-MF file` ：指定依赖文件名，比如编译 STM32 时需要加入 `-MF"build/stm32f1xx_hal_exti.d"` 选项，这样在编译时才能生成 build/stm32f1xx_hal_exti.d 文件，用于编译依赖管理。当与-M或-MM一起使用时，指定要将依赖项写入的文件。如果没有-MF开关，预处理器会将规则发送到与发送预处理输出相同的位置。当与驱动程序选项-MD或-MMD一起使用时，-MF将覆盖默认的依赖项输出文件。如果file为-，则依赖项将写入stdout。

- **3.15 Passing Options to the Assembler**
    - *Assembler Options*
        - `-Wa,option` ：将选项作为一个选项传递给汇编程序。如果选项包含逗号，则在逗号处将其拆分为多个选项。比如 stm32 编译时指定 `-Wa,-a,-ad,-alms=build/stm32f1xx_hal_exti.lst`。

- **3.16 Options for Linking**
    - *Linker Options*
        - `-l library` ：指定链接库
        - `-T file` ：指定链接脚本，比如编译 STM32 时需要加入 `-T"../STM32F103C8Tx_FLASH.ld"` 选项，这样在编译时才能找到链接脚本。
        - `-Wl,option` ：将选项作为一个选项传递给链接器。如果选项包含逗号，则在逗号处将其拆分为多个选项。比如编译 STM32 时需要加入 `-Wl,-Map=build/led.map,--cref` 选项，这样在编译时才能生成 build/led.map 文件。

- **3.17 Options for Directory Search**
    - *Directory Options*
        - `-I dir` ：指定头文件搜索路径，比如编译 STM32 时需要加入 `-I"../Inc"` 选项，这样在编译时才能找到头文件。

- **3.20 Machine-Dependent Options**
    在交叉编译环境中使用较多，多用于指定目标机器的依赖选项。
    - *ARM Options (ARM Options)* ：
        - `-mcpu=name` ：比如编译 STM32 需要指定 -mcpu=cortex-m3
        - `-mthumb` ：编译 Thumb 指令集
        - `-mfpu=name` ：编译浮点数支持，比如 -mfpu=fpv4-sp-d16

--------------

## 2. STM32CubeMX 生成的 Makefile 编译代码流程分析
### 2.1. 脚本执行 GCC 命令分析
以下为 STM32CubeMX 生成的 Makefile 使用 make 命令运行后的打印内容，其中中间命令类型部分已省略。
```powershell
PS C:\Users\11075579\Desktop\led> make
mkdir build
arm-none-eabi-gcc -c -mcpu=cortex-m3 -mthumb   -DUSE_HAL_DRIVER -DSTM32F103xB -ICore/Inc -IDrivers/STM32F1xx_HAL_Driver/Inc/Legacy -IDrivers/STM32F1xx_HAL_Driver/Inc -IDrivers/CMSIS/Device/ST/STM32F1xx/Include -IDrivers/CMSIS/Include -Og -Wall -fdata-sections -ffunction-sections -g -gdwarf-2 -MMD -MP -MF"build/main.d" -Wa,-a,-ad,-alms=build/main.lst Core/Src/main.c -o build/main.o

···

arm-none-eabi-gcc -x assembler-with-cpp -c -mcpu=cortex-m3 -mthumb   -DUSE_HAL_DRIVER -DSTM32F103xB -ICore/Inc -IDrivers/STM32F1xx_HAL_Driver/Inc/Legacy -IDrivers/STM32F1xx_HAL_Driver/Inc -IDrivers/CMSIS/Device/ST/STM32F1xx/Include -IDrivers/CMSIS/Include -Og -Wall -fdata-sections -ffunction-sections -g -gdwarf-2 -MMD -MP -MF"build/startup_stm32f103xb.d" startup_stm32f103xb.s -o build/startup_stm32f103xb.o

arm-none-eabi-gcc build/main.o build/stm32f1xx_it.o build/stm32f1xx_hal_msp.o build/stm32f1xx_hal_gpio_ex.o build/stm32f1xx_hal.o build/stm32f1xx_hal_rcc.o build/stm32f1xx_hal_rcc_ex.o build/stm32f1xx_hal_gpio.o build/stm32f1xx_hal_dma.o build/stm32f1xx_hal_cortex.o build/stm32f1xx_hal_pwr.o build/stm32f1xx_hal_flash.o build/stm32f1xx_hal_flash_ex.o build/stm32f1xx_hal_exti.o build/system_stm32f1xx.o build/startup_stm32f103xb.o  -mcpu=cortex-m3 -mthumb   -specs=nano.specs -TSTM32F103XX_FLASH.ld  -lc -lm -lnosys  -Wl,-Map=build/led.map,--cref -Wl,--gc-sections -o build/led.elf

arm-none-eabi-size build/led.elf
   text    data     bss     dec     hex filename
   3292      12    1540    4844    12ec build/led.elf
arm-none-eabi-objcopy -O ihex build/led.elf build/led.hex
arm-none-eabi-objcopy -O binary -S build/led.elf build/led.bin
```

由以上文件可以看出，makefile 将编译步骤分成了 4 部分：
1. 所有项目中包含的 `.c` 文件都用同样的命令编译成 `.o` 文件到新建的 build 目录下；
    - `-mcpu=cortex-m3 -mthumb` ：用于指定交叉编译的 CPU 类型和指令集类型；
    - `-DUSE_HAL_DRIVER -DSTM32F103xB` ：用于指定编译时加入的宏定义，该宏主要用于 `stm32f1xx.h` 头文件中对 HAL 库还是标准库的引用，以及芯片型号的指定，赋予不同的寄存器；
    - `-ICore/Inc -IDrivers/STM32F1xx_HAL_Driver/Inc/Legacy -IDrivers/STM32F1xx_HAL_Driver/Inc -IDrivers/CMSIS/Device/ST/STM32F1xx/Include -IDrivers/CMSIS/Include` ：用于指定头文件搜索路径；
    - `-Og` ：指定优化等级为调试优化，方便调试程序；
    - `-Wall` ：启用大多数警告；
    - `-fdata-sections -ffunction-sections` ：指定链接器将每个数据段放入单独的输出段中；
    - `-g` ：生成调试信息，供 GDB 使用；
    - `-gdwarf-2` ：指定调试信息的格式，指定为 DWARF2 格式。
    - `-MMD` ：生成依赖关系文件（.d 文件），记录源文件依赖的头文件。
    - `-MP` ：为依赖文件中的每个头文件添加一个空目标规则（避免头文件删除时报错）。
    - `-MF"build/main.d"` ：指定依赖文件（.d 文件）的输出路径和名称。
    - `-Wa,-a,-ad,-alms=build/main.lst` ：传递选项给汇编器（as），生成汇编列表文件。
    - `Core/Src/main.c -o build/main.o` ：用于指定编译的源文件和编译后的输出文件；

2. 启动文件 `.S` 文件编译成 `.o` 文件到新建的 build 目录下。
    - 不同于 C 文件的是该语法使用了 -x 命令显示的指定了文件的语言为汇编语言；
    - 其他选项与上述 C 文件编译相同，不再赘述。

3. 将所有编译后的 `.o` 文件链接为 `.elf` 文件，同时指定了链接脚本为 `STM32F103XX_FLASH.ld` ，并指定了链接选项 `-specs=nano.specs`，该选项指定了使用 nano.specs 文件中的链接器脚本，nano.specs 文件中定义了链接器脚本中使用的符号和段。
    - `-specs=nano.specs` ：
    - `-TSTM32F103XX_FLASH.ld` ：指定链接脚本。
    - `-lc -lm -lnosys` ：指定编译需要依赖的链接库。
    - `-Wl,-Map=build/led.map,--cref` ：将后续参数传递给链接器（`ld`）。
        - `-Map=build/led.map` ：生成链接器生成的 **内存映射文件**（Memory Map File），在 .map 格式文件中记录程序的内存布局、符号地址、段大小等信息。调试时分析代码占用空间、优化内存布局。 
        - `--cref` ：在映射文件中添加 **交叉引用表**（Cross Reference Table），在 .map 格式文件中显示符号在哪些目标文件/库中被引用。  
    - `-Wl,--gc-sections` ：启用 **垃圾回收（Garbage Collection）**，删除未被引用的代码段和数据段，显著减少固件体积（尤其适合嵌入式开发）。链接器会遍历所有入口符号（如 `_start`、`main`），仅保留被直接或间接引用的段。编译时需配合 `-ffunction-sections -fdata-sections`，让每个函数/变量单独成段。  
    - `-o build/led.elf` ：指定链接后的输出文件。

4. 将 `.elf` 文件转换为 `.hex` 文件和 `.bin` 文件。
    - `arm-none-eabi-size` 命令可以打印出 `.elf` 文件大小和代码段大小；
    - `arm-none-eabi-objcopy` 命令进行格式转换和内容操作，常用于嵌入式系统的固件生成和优化。将 `.elf` 文件转换为 `.hex` 文件和 `.bin` 文件。
    - `-O ihex` ：指定输出文件格式为 Intel HEX 格式，即 `.hex` 文件，用于烧录到芯片中；
    - `-O binary -S` ：指定输出文件格式为二进制格式，即 `.bin` 文件，并去除所有符号和调试信息，只保留机器码。

### 2.2. Makefile 文件展示
列出以下 Makefile 文件的源文件，自行构建项目时，可供参考。
```makefile
##########################################################################################################################
# File automatically-generated by tool: [projectgenerator] version: [4.6.0.1-B1] date: [Thu May 15 17:02:59 CST 2025] 
##########################################################################################################################

# ------------------------------------------------
# Generic Makefile (based on gcc)
#
# ChangeLog :
#	2017-02-10 - Several enhancements + project update mode
#   2015-07-22 - first version
# ------------------------------------------------

######################################
# target
######################################
TARGET = led


######################################
# building variables
######################################
# debug build?
DEBUG = 1
# optimization
OPT = -Og


#######################################
# paths
#######################################
# Build path
BUILD_DIR = build

######################################
# source
######################################
# C sources
C_SOURCES =  \
Core/Src/main.c \
Core/Src/stm32f1xx_it.c \
Core/Src/stm32f1xx_hal_msp.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_gpio_ex.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_rcc.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_rcc_ex.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_gpio.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_dma.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_cortex.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_pwr.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_flash.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_flash_ex.c \
Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal_exti.c \
Core/Src/system_stm32f1xx.c

# ASM sources
ASM_SOURCES =  \
startup_stm32f103xb.s

# ASM sources
ASMM_SOURCES = 


#######################################
# binaries
#######################################
PREFIX = arm-none-eabi-
# The gcc compiler bin path can be either defined in make command via GCC_PATH variable (> make GCC_PATH=xxx)
# either it can be added to the PATH environment variable.
ifdef GCC_PATH
CC = $(GCC_PATH)/$(PREFIX)gcc
AS = $(GCC_PATH)/$(PREFIX)gcc -x assembler-with-cpp
CP = $(GCC_PATH)/$(PREFIX)objcopy
SZ = $(GCC_PATH)/$(PREFIX)size
else
CC = $(PREFIX)gcc
AS = $(PREFIX)gcc -x assembler-with-cpp
CP = $(PREFIX)objcopy
SZ = $(PREFIX)size
endif
HEX = $(CP) -O ihex
BIN = $(CP) -O binary -S
 
#######################################
# CFLAGS
#######################################
# cpu
CPU = -mcpu=cortex-m3

# fpu
# NONE for Cortex-M0/M0+/M3

# float-abi


# mcu
MCU = $(CPU) -mthumb $(FPU) $(FLOAT-ABI)

# macros for gcc
# AS defines
AS_DEFS = 

# C defines
C_DEFS =  \
-DUSE_HAL_DRIVER \
-DSTM32F103xB


# AS includes
AS_INCLUDES = 

# C includes
C_INCLUDES =  \
-ICore/Inc \
-IDrivers/STM32F1xx_HAL_Driver/Inc/Legacy \
-IDrivers/STM32F1xx_HAL_Driver/Inc \
-IDrivers/CMSIS/Device/ST/STM32F1xx/Include \
-IDrivers/CMSIS/Include


# compile gcc flags
ASFLAGS = $(MCU) $(AS_DEFS) $(AS_INCLUDES) $(OPT) -Wall -fdata-sections -ffunction-sections

CFLAGS += $(MCU) $(C_DEFS) $(C_INCLUDES) $(OPT) -Wall -fdata-sections -ffunction-sections

ifeq ($(DEBUG), 1)
CFLAGS += -g -gdwarf-2
endif


# Generate dependency information
CFLAGS += -MMD -MP -MF"$(@:%.o=%.d)"


#######################################
# LDFLAGS
#######################################
# link script
LDSCRIPT = STM32F103XX_FLASH.ld

# libraries
LIBS = -lc -lm -lnosys 
LIBDIR = 
LDFLAGS = $(MCU) -specs=nano.specs -T$(LDSCRIPT) $(LIBDIR) $(LIBS) -Wl,-Map=$(BUILD_DIR)/$(TARGET).map,--cref -Wl,--gc-sections

# default action: build all
all: $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).hex $(BUILD_DIR)/$(TARGET).bin


#######################################
# build the application
#######################################
# list of objects
OBJECTS = $(addprefix $(BUILD_DIR)/,$(notdir $(C_SOURCES:.c=.o)))
vpath %.c $(sort $(dir $(C_SOURCES)))
# list of ASM program objects
OBJECTS += $(addprefix $(BUILD_DIR)/,$(notdir $(ASM_SOURCES:.s=.o)))
vpath %.s $(sort $(dir $(ASM_SOURCES)))
OBJECTS += $(addprefix $(BUILD_DIR)/,$(notdir $(ASMM_SOURCES:.S=.o)))
vpath %.S $(sort $(dir $(ASMM_SOURCES)))

$(BUILD_DIR)/%.o: %.c Makefile | $(BUILD_DIR) 
	$(CC) -c $(CFLAGS) -Wa,-a,-ad,-alms=$(BUILD_DIR)/$(notdir $(<:.c=.lst)) $< -o $@

$(BUILD_DIR)/%.o: %.s Makefile | $(BUILD_DIR)
	$(AS) -c $(CFLAGS) $< -o $@
$(BUILD_DIR)/%.o: %.S Makefile | $(BUILD_DIR)
	$(AS) -c $(CFLAGS) $< -o $@

$(BUILD_DIR)/$(TARGET).elf: $(OBJECTS) Makefile
	$(CC) $(OBJECTS) $(LDFLAGS) -o $@
	$(SZ) $@

$(BUILD_DIR)/%.hex: $(BUILD_DIR)/%.elf | $(BUILD_DIR)
	$(HEX) $< $@
	
$(BUILD_DIR)/%.bin: $(BUILD_DIR)/%.elf | $(BUILD_DIR)
	$(BIN) $< $@	
	
$(BUILD_DIR):
	mkdir $@		

#######################################
# clean up
#######################################
clean:
	-rm -fR $(BUILD_DIR)
  
#######################################
# dependencies
#######################################
-include $(wildcard $(BUILD_DIR)/*.d)

# *** EOF ***
```